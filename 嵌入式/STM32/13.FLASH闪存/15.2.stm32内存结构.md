# STM32微控制器的内存结构

## 1. 存储器的类型与地址分配

### (1) Flash存储器（程序存储器）
- **地址范围**：通常从 `0x0800 0000` 开始（主Flash）
- **用途**：
  - 存储程序代码（`.text` 段）、常量数据（`.rodata` 段）
  - 中断向量表（默认位于Flash起始位置，可重定位到RAM）
  - 用户数据（非易失性配置参数）
- **特点**：
  - 分块结构（Sectors/Pages），支持擦写操作
  - 容量因型号不同（如STM32F103C8T6为64KB，STM32F407VET6为512KB）

### (2) RAM（运行内存）
- **地址范围**：通常从 `0x2000 0000` 开始（主SRAM）
- **用途**：
  - 栈（Stack）、堆（Heap）、全局变量、静态变量（`.data` 和 `.bss` 段）
  - 动态分配的运行时数据（通过 `malloc` 或 FreeRTOS 管理）
- **特点**：
  - 容量因型号不同（如STM32F103C8T6为20KB，STM32F407VET6为192KB）
  - 部分型号支持 **CCM RAM**（地址如 `0x1000 0000`），仅CPU可直接访问

### (3) 系统存储器（System Memory）
- **地址范围**：`0x1FFF 0000`（依型号不同）
- **用途**：
  - 存储出厂预置的 **Bootloader**
  - 通过UART/USB更新用户程序

### (4) 选项字节（Option Bytes）
- **地址范围**：位于Flash的特定区域（如 `0x1FFF F800`）
- **用途**：
  - 配置读写保护、看门狗、复位模式等
  - 通过专用函数（如 `HAL_FLASHEx_OBProgram`）修改

---

## 2. 外设寄存器
- **地址范围**：`0x4000 0000` 至 `0x5FFF FFFF`（APB/AHB总线外设）
- **用途**：
  - 控制GPIO、UART、SPI、定时器等外设的寄存器
  - 示例：`GPIOA->ODR = 0x01;`

---

## 3. 其他特殊内存区域

### (1) 位带区（Bit-Banding）
- **地址映射**：
  - 外设位带区：`0x4000 0000` → 别名区 `0x4200 0000`
  - SRAM位带区：`0x2000 0000` → 别名区 `0x2200 0000`
- **用途**：
  - 原子操作单个比特（示例：`*((volatile uint32_t*)0x22000008) = 1;`）

### (2) 备份SRAM（BKP SRAM）
- **地址范围**：部分型号支持（如STM32F4的 `0x40024000`）
- **用途**：
  - 低功耗模式下由VBAT供电保持数据
  - 存储RTC配置、系统状态

---

## 4. 启动配置与内存映射
- **启动模式**（通过BOOT引脚设置）：
  - **主Flash**：`0x0800 0000`（默认用户程序启动）
  - **系统存储器**：`0x1FFF 0000`（Bootloader模式）
  - **内置SRAM**：`0x2000 0000`（调试或临时程序）
- **地址重映射**：启动区域起始地址映射到 `0x0000 0000`

---

## 5. 内存保护单元（MPU）
- **用途**：
  - 配置内存区域访问权限（如只读、不可执行）
  - 增强系统安全性（Cortex-M3/M4/M7支持）

---

## 6. 不同型号的差异
| 系列         | 特性差异                                                                 |
|--------------|--------------------------------------------------------------------------|
| STM32F1      | 无CCM RAM，Flash/RAM较小                                                 |
| STM32F4      | 支持CCM RAM，更大容量（如F407: 1MB Flash + 192KB SRAM）                   |
| STM32H7      | 双Bank Flash，多块RAM（如AXI SRAM、DTCM RAM）                            |

---

## 总结
| 内存区域       | 主要用途                                   |
|----------------|--------------------------------------------|
| Flash          | 程序代码、常量、中断向量表                 |
| RAM            | 运行时数据、堆栈、全局变量                 |
| 外设寄存器     | 硬件控制接口                               |
| 系统存储器     | Bootloader和芯片配置                       |
| 特殊区域       | 性能优化或特定功能（如位带、CCM、备份SRAM）|