前文所述，一个 CANopen 网络中为了保证可靠、可控，必须要 NMT 网络管理，就像
一个军队一样，要令行禁止，才能达到稳定、高效的目标。

**所以每个 CANopen 从节点的 CANopen 协议栈中，必须具备 NMT 管理的相应代码，
这是节点具备 CANopen 协议的最基本的要素**。

## 4.1 NMT 节点状态
NMT 管理涉及到一个 CANopen 节点从上电开始的 6 钟状态，包括：  
- **初始化**（Initializing）：节点上电后对功能部件包括 CAN 控制器进行初始化；
- **应用层复位**（Application Reset）：节点中的应用程序复位（开始），比如开关量输
出、模拟量输出的初始值；
- **通讯复位**（Communication reset）：节点中的CANopen通讯复位（开始），从这个时
刻起，此节点就可以进行CANopen通讯了。
- **预操作状态**（Pre-operational）：节点的CANopen通讯处于操作就绪状态，此时此节
点不能进行PDO通信，而可以进行SDO进行参数配置和NMT网络管理的操作；
- **操作状态**（operational）：节点收到NMT主机发来的启动命令后，CANopen通讯被
激活，PDO通信启动后，按照对象字典里面规定的规则进行传输，同样SDO也可以
对节点进行数据传输和参数修改；
- **停止状态**（Stopped）：节点收到NMT主机发来的停止命令后，节点的PDO通信被
停止，但SDO和NMT网络管理依然可以对节点进行操作；

除了初始化状态，NMT主机通过NMT命令可以让网络中任意一个的CANopen节点
进行其他5种状态的切换。如下图所示。

**当然CANopen节点也可以程序自动完成这些状态的切换**。  

![](./images/4-NMT管理状态转换图.png"></div>

## 4.2 NMT节点上线报文

任何一个 CANopen 从站上线后，为了提示主站它已经加入网络（便于热插拔），或者
避免与其他从站 Node-ID 冲突。这个从站必须发出**节点上线报文（boot-up）**，如下图所示，节点上线报文的 **ID 为 700h+Node-ID，数据为 1 个字节 0**。生产者为 CANopen 从站。

![](./images/4-NMT节点上线报文.png"></div>

## 4.3 NMT 节点状态与心跳报文

为了监控 CANopen 节点是否在线与目前的节点状态。CANopen 应用中通常都要求在线
上电的从站定时发送状态报文（心跳报文），以便于主站确认从站是否故障、是否脱离网络。

如下图所示，为心跳报文发送的格式，CANID与节点上线报文相同为**700h+Node-ID，
数据为 1 个字节，代表节点目前的状态，04h为停止状态，05h为操作状态，7Fh为预操作状
态**。

![](./images/4-NMT心跳报文.png"></div>

CANopen 从站按其对象字典中 1017h 中填写的心跳生产时间（ms）进行心跳报文的发
送，而 CANopen 主站（NMT 主站）则会按其 1016h 中填写的心跳消费时间进行检查，假设
超过诺干次心跳消费时间没有收到从站的心跳报文，则认为从站已经离线或者损坏。

## 4.4 NMT 节点守护
在早期 CANopen 应用中，还有一种可以通过**轮询模式监视从站状态的节点守护模式，
它与心跳报文模式二者不能并存**。通过节点守护，MNT 主机可以检查每个节点的当前状态。

NMT-Master 节点发送**标准远程帧**（无数据）如下：
![](./images/4-NMT节点守护1.png"></div>

NMT-Slave 节点**应答发送数据帧，数据为 1 个字节**：
![](./images/4-NMT节点守护2.png"></div>

数据部分包括一个触发位（bit7），**触发位必须在每次节点保护应答中交替置“0”或者
“1”**。触发位在第一次节点保护请求时置为“0”。位 0 到位 6（bits0～6）表示节点状态，
可为下表中的数值。
![](./images/4-NMT节点守护状态.png"></div>

**由于远程帧在 CAN 发展中逐渐被淘汰，而节点守护由于需要更多的主站开销与增加网
络负载，CiA 协会已经不建议使用，被心跳报文所取代。**

## 4.5 节点状态切换命令

NMT 网络管理中，**最核心的就是 NMT 节点状态切换命令**，这是 NMT 主站所进行网
络管理的“命令”报文。**使用者必须牢记这些命令。**

**CANID 均为 000h，具备最高的 CAN 优先级。数据为 2 个字节：**  
- 第 1 个字节代表命令类型：  
  - 01h为启动命令（让节点进入操作状态）；
  - 02h为停止命令（让节点进入停止状态）；
  - 80h为进入预操作状态（让节点进入预操作状态）；
  - 81h为复位节点应用层（让节点的应用恢复初始状态，比如列车门都恢复打开状态）；
  - 82h为复位节点通讯（让节点的 CAN 和 CANopen 通讯重新初始化，一般用于总线收到
干扰，导致节点总线错误被动，或者总线关闭时）。

- 第二个字节代表被控制的节点 Node-ID  

**如果要对整个网络所有节点同时进行控制，则这个数值为 0 即可。** 如下图所示：
![](./images/4-NMT节点状态切换命令.png"></div>

## 4.6 CANopen主站设备
通常 NMT 主站也称为 CANoepn 主站，上文所述为 CANopen 最基本的 NMT 操作，而
作为一个完整的 CANopen 主站设备，设备模型如下图所示。为了满足管理整个 CANopen
网络的从站设备，需要具备以下功能：  
- 支持 PDO、SDO 发送与接收；
- 支持 NMT 网络管理；
- 支持 PDO 通信类型并能够支持监控每一个 PDO 目标；
- LSS 层设置功能：从站波特率设置、从站节点编号设置；
- 支持从站管理功能：类型与名称读取、对象字典读写；
- 紧急报文发送功能；
- 扩展 CANopen 标准指示灯功能。

![](./images/4-CANopen设备模型.png"></div>

目前有二种形式的主站，一种是可编程控制器（PLC）中的一个单元，它的内部集成了
CANopen 的主站功能，这个单元能连接到 CANopen 总线，同时因为它是 PLC 中的一个单
元，它能与 PLC 的 CPU 交换数据，因此通过编写 PLC 程序对它所连接的 CANopen 从站进
行管理和控制。如下图所示：

![](./images/4-带CANopen的PLC.png"></div>

另一种是通过 PC 扩展一个 CANopen 主站通信卡，从而令 PC 具有管理 CANopen 通信
网络的能力。推荐使用 PCI 总线或 USB 总线来扩展 CANopen 通信卡，比如广州致远电子
股份有限公司的 PCI-5010-P 或 USBCAN-E-P 主站卡，下如图所示。使用它们不仅可以令
PC 成为一个 CANopen 网络的管理节点，还可以开发或测试 CANopen 网络、拓展连接其他
网络。如下图所示：

![](./images/4-推荐的CANopen主站通信卡.png"></div>

PCI-5010-P 通信卡内嵌 1 路隔离 CAN 接口，常用于工控场合，通过 PCI 总线连接工
控 PC 机；USBCAN-E-P 通信卡也带 1 路全隔离 CAN 接口，常用于便携测试领域，通过 USB
总线连接测试 PC 机。这两款设备的内嵌 CAN 接口都设计有增强隔离、ESD、EFT、EMI
等多种保护措施，保障设备在干扰恶劣环境中的可靠通信。同时，配套各种 CANopen 支持
软件，有 CANopen 函数库、编程示例、监控与测试软件、OPC 服务器、协议分析等。
另外，作为通用的 CANopen 通信接口卡，这两款设备还具有硬件自动存储报文、通用 CAN
报文收发、总线参数诊断等增强功能，方便进行复杂网络的二次开发。